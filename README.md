## Анонимизатор

Здесь находится высокофункциональный и быстрый анонимизатор для медицинских документов в различных форматах. Сервис поддерживает файлы форматов PDF, PNG, JPG, JPEG, DOC и DOCX. Для файлов DOC/DOCX сервис автоматически конвертирует их в PDF перед обработкой.

## Инструкция по установке и запуску

Удобнее всего использовать докер-образ, но процесс установки без докера также описан ниже.

### Docker

Требуется установленный Docker.

Сборка образа осуществляется запуском в папке репозитория в терминале команды ```docker build -t ocr-app .```. Если у вас Mac с ARM-архитектурой (Mac M1 и последующие), запустите вместо этого команду ```docker build --platform linux/amd64 -t ocr-app .```.

Запуск осуществляется командой ```docker run -d -p 8000:8000 ocr-app```. После первого запуска требуется подождать пару минут, пока загрузятся необходимые файлы.

При сборке и первом запуске требуется подключение к интернету для загрузки необходимых библиотек и моделей. В связи с этим сервис может быть несколько минут недоступен после первого запуска образа. После этого решение работает локально без обращения к сторонним сервисам.

Сервис будет доступен по порту 8000. Проверить работу API можно в веб-интерфейсе по адресу http://127.0.0.1:8000/docs (функция upload -> Try it out -> выбрать файл -> Execute). Пример обращения к API из терминала:
```
# Для PDF файла:
curl -X 'POST' \
  'http://127.0.0.1:8000/upload/' \
  -H 'accept: application/pdf' \
  -H 'Content-Type: multipart/form-data' \
  -F 'file=@<filepath>;type=application/pdf' --output output.pdf

# Для DOC/DOCX файла:
curl -X 'POST' \
  'http://127.0.0.1:8000/upload/' \
  -H 'accept: application/pdf' \
  -H 'Content-Type: multipart/form-data' \
  -F 'file=@<filepath>;type=application/msword' --output output.pdf
```

### Без докера

Для того, чтобы пользоваться данным продуктом, необходимо иметь
 * Python, мы рекоммендуем использовать версию 3.10 для полной совместимости. Также нужно иметь установленный pip.
 * Для работы с основным модулем OCR требуется иметь работающий Tesseract. Для Windows его можно скачать здесь: https://github.com/UB-Mannheim/tesseract/wiki. Для Mac достаточно выполнить в терминале команды ```brew install tesseract``` и ```brew install tesseract-lang``` (установка brew описана на сайте: https://brew.sh/). В Ubuntu/Debian Tesseract устанавливается командой ```sudo apt-get update && sudo apt-get install tesseract-ocr tesseract-ocr-rus```.
 * Также необходим пакет OpenCV. На Ubuntu/Debian требуется выполнить команду ```sudo apt-get install python3-opencv```.
 * Для работы с pdf-файлами требуется пакет poppler. На Ubuntu/Debian его можно установить командой ```sudo apt-get install poppler-utils```. На Mac его можно установить с помощью brew: ```brew install poppler```. На Windows нужно скачать установщик с сайта https://github.com/oschwartz10612/poppler-windows/releases/ и добавить путь к папке bin в переменные среды PATH.
 * Для работы с DOC/DOCX файлами требуется LibreOffice и unoconv:
   - Ubuntu/Debian: ```sudo apt-get install libreoffice unoconv```
   - Mac: ```brew install libreoffice``` и ```brew install unoconv```
   - Windows: установите LibreOffice с официального сайта: https://www.libreoffice.org/download/download/
 * Требуется установить необходимые библиотеки, это можно сделать, запустив в папке репозитория в терминале команду ```python -m pip install -U -r requirements.txt```.
 * При первом запуске возможны задержки, связанные с автоматической подгрузкой определенных моделей, рекомендуется первый запуск осуществлять с доступом к интернету. При этом после загрузки всех библиотек и моделей решение работает изолированно.

 После установки нужно выполнить в папке репозитория команду ```fastapi run rest.py```. Сервис будет доступен по порту 8000. Как и в случае с докером, проверить работу API можно в веб-интерфейсе по адресу http://127.0.0.1:8000/docs (функция upload -> Try it out -> выбрать файл -> Execute).


## Основные параметры и настройки

Главной функцией API является функция upload, принимающая файл с текстом (формата PNG, JPG, PDF, DOC, DOCX), а также несколько параметров:
- параметр ocr_engine определяет движок для OCR. Рекомендуется использовать tesseract (используется по умолчанию), в большей части случаев с ним достигается максимальное качество. Следует иметь в виду, что вариант easyocr требователен к памяти: только модель занимает порядка 7 Гб ОЗУ (в дополнение к остальному образу).
- параметр date_year_max: даты с годом, большим этого параметра, не максируются. Это необходимо для того, чтобы, например, даты исследований и процедур не закрашивались, в отличие от дат рождения. Параметр можно настраивать в зависимости от распределения возрастов пациентов. По умолчанию 2016.
- параметр auto_rotate: автоматически определяет и корректирует ориентацию изображения, используя функционал Tesseract для определения ориентации. Этот параметр особенно полезен для обработки сканированных или фотографированных документов, которые могут быть загружены в неправильной ориентации. По умолчанию true. **Важно:** функция auto_rotate поддерживается только при использовании движка tesseract и будет автоматически отключена при использовании easyocr.
- параметр stamp_removal_method: определяет метод удаления печатей и штампов. Возможные значения:
  - **nothing** не удалять.
  - **circle**: использует метод обнаружения кругов, но имеет ложноположительные срабатывания.
  - **contour** (рекомендуется, используется по умолчанию): использует контурный метод,.
  - **blue** метод для закраски синих печатей и подписей.

Возможность выбора параметров в веб-интерфейсе появляется только после нажатия Try it out.

## Демонстрация

После запуска сервиса и перехода по адресу http://127.0.0.1:8000/docs с нажатием "Try it out" появляется меню
![изображение](https://github.com/interestquestion/anonimization/assets/134848896/4170d237-1609-4efe-ba2d-d808f824d8bd)

Здесь можно настраивать основные параметры ввода-вывода и запускать процесс анонимизации.
