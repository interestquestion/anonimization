## Анонимизатор

Здесь находится высокофункциональный и быстрый анонимизатор для медицинских документов в различных форматах.

## Инструкция по установке и запуску

Удобнее всего использовать докер-образ, но процесс установки без докера также описан ниже.

### Docker

Требуется установленный Docker.

Сборка образа осуществляется запуском в папке репозитория в терминале команды ```docker build -t ocr-app .```. Если у вас Mac с ARM-архитектурой (Mac M1 и последующие), запустите вместо этого команду ```docker build --platform linux/amd64 -t ocr-app .```.

Запуск осуществляется командой ```docker run -d -p 8000:8000 ocr-app```. После первого запуска требуется подождать пару минут, пока загрузятся необходимые файлы.

При сборке и первом запуске требуется подключение к интернету для загрузки необходимых библиотек и моделей. После этого решение работает локально без обращения к сторонним сервисам.

Сервис будет доступен по порту 8000. Проверить работу API на файлах форматов png, jpg и др. можно в веб-интерфейсе по адресу http://127.0.0.1:8000/docs (функция upload -> Try it out -> выбрать файл -> Execute). Проверить работу на pdf-файлах можно, запустив команду в терминале 
```
curl -X 'POST' \
  'http://127.0.0.1:8000/upload/' \
  -H 'accept: application/pdf' \
  -H 'Content-Type: multipart/form-data' \
  -F 'file=@<filepath>;type=application/pdf' --output output.pdf
```

### Без докера

Для того, чтобы пользоваться данным продуктом, необходимо иметь
 * Python, мы рекоммендуем использовать версию 3.10 для полной совместимости. Также нужно иметь установленный pip.
 * Для работы с основным модулем OCR требуется иметь работающий Tesseract. Для Windows его можно скачать здесь: https://github.com/UB-Mannheim/tesseract/wiki. Для Mac достаточно выполнить в терминале команды ```brew install tesseract``` и ```brew install tesseract-lang``` (установка brew описана на сайте: https://brew.sh/). В Linux Tesseract устанавливается командой ```sudo apt-get update && sudo apt-get install tesseract-ocr tesseract-ocr-rus```.
 * Также необходим пакет OpenCV. На Linux его можно установить командой ```sudo apt-get install python3-opencv```.
 * Требуется установить необходимые библиотеки, это можно сделать, запустив в папке репозитория в терминале команду ```python -m pip install -U -r requirements.txt```.
 * При первом запуске возможны задержки, связанные с автоматической подгрузкой определенных моделей, рекомендуется первый запуск осуществлять с доступом к интернету. При этом после загрузки всех библиотек и моделей решение работает изолированно.

 После установки нужно выполнить в папке репозитория команду ```fastapi run rest.py```. Сервис будет доступен по порту 8000. Как и в случае с докером, проверить работу API можно в веб-интерфейсе по адресу http://127.0.0.1:8000/docs (функция upload -> Try it out -> выбрать файл -> Execute).


## Основные параметры и настройки

Главной функцией API является функция upload, принимающая файл с текстом (формата png, jpg, pdf и др.), а также несколько параметров:
- параметр ocr_engine определяет движок для OCR. Рекомендуется использовать tesseract (используется по умолчанию), в большей части случаев с ним достигается максимальное качество.
- параметр date_year_max: даты с годом, большим этого параметра, не максируются. Это необходимо для того, чтобы, например, даты исследований и процедур не закрашивались, в отличие от дат рождения. Параметр можно настраивать в зависимости от распределения возрастов пациентов. По умолчанию 2016.
Возможность выбора параметров в веб-интерфейсе появляется только после нажатия Try it out.

## Демонстрация

После запуска сервиса и перехода по адресу http://127.0.0.1:8000/docs с нажатием "Try it out" появляется меню
![изображение](https://github.com/interestquestion/anonimization/assets/134848896/4170d237-1609-4efe-ba2d-d808f824d8bd)

Здест можно настраивать основные параметры ввода-вывода и запускать процесс анонимизации.
